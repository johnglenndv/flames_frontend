<!DOCTYPE html>
<html>
<head>
    <title>F.L.A.M.E.S. | Dashboard</title>
    <link rel="icon" type="image/png" href="icons/heading-logo.png">
    <link rel="stylesheet" href="static/dashboard.css">
    <link rel="stylesheet" href="static/flames-map.css">
    <link rel="stylesheet" href="static/screen design.css">
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet-routing-machine/dist/leaflet-routing-machine.css" />

    <!-- mqtt.js for real-time WebSocket connection -->
    <script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>

    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta charset="UTF-8"> 
</head>

<body>

    <!-- Your existing header, side panel, search, pinned locations remain unchanged -->

    <!-- Node Status â€“ now real-time via MQTT -->
    <div class="node-status-box" id="nodeBox">
        <div class="node-header">
            <span style="font-weight: 600;">Node Status</span>
            <div id="header-right">Waiting for data...</div>
        </div>
        
        <div id="status-content">
            <p>Waiting for first sensor reading...</p>
            <div id="mqtt-status" style="font-size:0.9em; color:#888; margin-top:8px;">
                Connecting to live feed...
            </div>
        </div>
    </div>

    <!-- Live Incidents â€“ will be updated dynamically when flame/smoke detected -->
    <div class="fire-incidents-box" id="fireBox">
        <div class="fire-incidents-header">
            <span style="font-weight: 600;">Live Incidents</span>
            <span class="incident-badge">
                <img src="icons/FireIncident.png" alt="fire" class="badge-icon">
                <span id="incident-count">0</span>
            </span>
        </div>

        <div class="incident-list" id="incident-list">
            <p style="text-align:center; color:#888; padding:30px;">
                Monitoring for fire/smoke alerts...
            </p>
        </div>
    </div>

    <!-- Your existing map and network status boxes remain -->

    <!-- Scripts -->
    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
    <script src="https://unpkg.com/leaflet-routing-machine/dist/leaflet-routing-machine.js"></script>
    <script src="static/map.js"></script>
    <script src="static/OpenRouteService.js"></script>
    <script src="static/ProfileSettings.js"></script>

    <!-- Real-time MQTT subscription -->
    <script>
        // ==================== MQTT REAL-TIME CONFIG ====================
        const MQTT_BROKER = "wss://528e719c19214a19b07c0e7322298267.s1.eu.hivemq.cloud:8884/mqtt";
        const MQTT_TOPIC  = "lora/uplink";
        const MQTT_USER   = "Downlink01";
        const MQTT_PASS   = "Downlink01";

        // ==================== CONNECT TO MQTT ====================
        const client = mqtt.connect(MQTT_BROKER, {
            username: MQTT_USER,
            password: MQTT_PASS,
            reconnectPeriod: 5000,
            connectTimeout: 10000,
            clean: true
        });

        client.on('connect', () => {
            console.log("âœ… Connected to HiveMQ â€“ real-time updates active");
            client.subscribe(MQTT_TOPIC, (err) => {
                if (!err) {
                    document.getElementById("mqtt-status").textContent = "Live feed connected";
                } else {
                    document.getElementById("mqtt-status").textContent = "Connection error";
                    console.error("Subscribe failed:", err);
                }
            });
        });

        client.on('message', (topic, message) => {
            try {
                const raw = message.toString();
                const data = JSON.parse(raw);
                console.log("ðŸ“¥ Live MQTT:", data);

                const payload = data.payload || {};
                const nodeId = payload.node || "Unknown";

                // ==================== UPDATE NODE STATUS ====================
                const statusContent = document.getElementById("status-content");
                const flameText = payload.flame === 1 
                    ? '<span style="color:#ff0000; font-weight:bold;">ðŸ”¥ FIRE DETECTED! ALERT!</span>'
                    : 'Normal';

                const smokeText = payload.smoke > 500 
                    ? '<span style="color:#ff8800; font-weight:bold;">HIGH SMOKE!</span>'
                    : payload.smoke;

                statusContent.innerHTML = `
                    <strong>Node:</strong> ${nodeId}<br>
                    <strong>Temperature:</strong> ${payload.temp ?? '--'} Â°C<br>
                    <strong>Humidity:</strong> ${payload.hum ?? '--'} %<br>
                    <strong>Flame:</strong> ${flameText}<br>
                    <strong>Smoke:</strong> ${smokeText}<br>
                    <strong>Location:</strong> 
                        ${payload.lat ? payload.lat.toFixed(6) : '--'}, 
                        ${payload.lon ? payload.lon.toFixed(6) : '--'}<br>
                    <strong>RSSI / SNR:</strong> ${data.rssi ?? '--'} dBm / ${data.snr ?? '--'} dB<br>
                    <strong>Received:</strong> ${data.received_at ? new Date(data.received_at).toLocaleString('en-PH') : 'Just now'}
                `;

                // ==================== FIRE ALERT ====================
                if (payload.flame === 1 || payload.smoke > 500) {
                    statusContent.style.backgroundColor = "#ffdddd";
                    statusContent.style.border = "3px solid red";
                    statusContent.style.animation = "flash 1.5s infinite";

                    // Play alert sound
                    new Audio("https://assets.mixkit.co/sfx/preview/mixkit-alarm-digital-996.mp3").play().catch(() => {});

                    setTimeout(() => {
                        statusContent.style.backgroundColor = "";
                        statusContent.style.border = "";
                        statusContent.style.animation = "";
                    }, 8000);
                }

                // ==================== OPTIONAL: MOVE MAP ====================
                if (payload.lat && payload.lon && typeof map !== 'undefined') {
                    map.setView([payload.lat, payload.lon], 15);
                }

            } catch (err) {
                console.error("Failed to parse MQTT message:", err);
            }
        });

        client.on('error', (err) => {
            console.error("MQTT Error:", err);
            document.getElementById("mqtt-status").textContent = "Connection error â€“ retrying...";
        });

        client.on('close', () => {
            console.log("MQTT disconnected â€“ reconnecting...");
            document.getElementById("mqtt-status").textContent = "Disconnected â€“ reconnecting...";
        });
    </script>

</body>
</html>