<!DOCTYPE html>
<html>
<head>

    <title>F.L.A.M.E.S. | Dashboard</title>
    <link rel="icon" type="image/png" href="icons/heading-logo.png">
    <link rel = "stylesheet" href="static/dashboard.css">
    <link rel = "stylesheet" href="static/flames-map.css">
    <link rel = "stylesheet" href="static/screen design.css">
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet-routing-machine/dist/leaflet-routing-machine.css" />
    

    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta charset="UTF-8"> 

    
    <script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>

</head>

<body>


    
    <div id="main-header"> 
        <h1><img src = "icons/logo.png" alt = "Frames" id="flames-logo" width = "65" height="60">
             F.L.A.M.E.S.
        </h1>

        <button id="profile-btn" class="profile-icon-btn">
            <img src="icons/Profile.png" alt="Profile">
        </button>
    </div> 

            <div id="side-panel" class="side-panel">

                <div class="panel-header">
                    <h2 style="color: white; margin: 0;">User Settings</h2>
                    <span id="close-panel" class="close-btn">&times;</span>
                </div>

                <button class="logout-btn" id="logout-trigger">
                    <img src="icons/logout-icon.png" alt="logout" class="btn-icon">
                    <span>Log Out</span>
                </button>

               <div class="display-settings-box">
                <h3>Display Settings</h3>
                    <div class="setting-item">
                            <span>Theme: <strong id="mode-text">Dark</strong></span>
                            <label class="theme-switch">
                                <input type="checkbox" id="mode-toggle" checked>
                                <div class="sun-moon-slider round"></div>
                            </label>
                    </div>
                </div>
            </div>

            <div id="panel-overlay" class="panel-overlay"></div>





            <div class="search-box">
                <div class="search-header">
                    <span>Search Location</span>
                </div>
                <div class="search-input">
                    <input type="text" id="mapSearchInput" placeholder="Search..." class="inner-input" oninput="handleSearch(this.value)">  
                    <span id="clearSearch" class="clr-btn" onclick="clearSearchInput()">&times;</span>    
                    <img src="icons/search-icon.png" alt="search" class="search-icon-inside">
                </div>
                <div id="suggestionsBox" class="suggestions-container"></div>
            </div>

            
            <div class="pinned-location-box">
                <div class="pinned-location-header">
                    <span>Pinned Locations</span>
                    <img src="icons/pinned-location.png" alt="icon" class="loc-icon-img">
                </div>

                <div class="pinned-main-content" id="pinned-counter-view">
                    <div class="pinned-counter">
                        <h1 id="pinned-count">0</h1>
                        <p>locations saved</p>
                    </div>
                    <button class="view-all-btn" id="view-all-btn">View All</button>
                </div>

                <div id="list-pinned-view" style="display: none; padding: 20px;">
                    <button class="hide-btn" id="hide-btn">Hide</button>
                    <div class="no-locations-msg">No locations pinned.</div>
                </div>
            </div>

        

            <div class="node-status-box" id="nodeBox">
                <div class="node-header">
                    <span style="font-weight: 600;">Node Status</span>
                    <div id="header-right">Select a node</div>
                </div>
                    
                <div id="status-content">
                    <p>Click a node to see its status.</p>
                </div>
            </div>

            <div class="fire-incidents-box" id="fireBox">
                    <div class="fire-incidents-header">
                        <span style="font-weight: 600;">Live Incidents</span>
                        <span class="incident-badge">
                            <img src="icons/FireIncident.png" alt="fire" class="badge-icon">
                            <span id="incident-count">5</span>
                        </span>
                            
                    </div>

                    <div class="incident-list">
                        <div class="incident-card">
                            <p style="text-align:center; color:#aaa; padding:20px;" id="no-incident-msg">Monitoring for fire/smoke alerts...</p>
                        </div>

                        <div class="incident-card">
                            <p style="text-align:center; color:#aaa; padding:20px;" id="no-incident-msg">Monitoring for fire/smoke alerts...</p>
                        </div>

                        <div class="incident-card">
                            <div class="incident-title">Tapestry (Bonuan)</div>
                            <div class="incident-status">Status: <span class="text-resolved">Resolved</span></div>
                            <button class="btn-show-map" onclick="routeToIncident(16.091100, 120.350100)">Show on Map & Route</button>
                        </div>

                        <div class="incident-card">
                            <div class="incident-title">Malued District</div>
                            <div class="incident-status">Status: <span class="text-active">Active</span></div>
                            <div class="incident-status">Assigned Team: JOHN GLENN</div>
                            <button class="btn-show-map" onclick="routeToIncident(16.033300, 120.323300)">Show on Map & Route</button>
                        </div>

                        <div class="incident-card">
                            <div class="incident-title">Bonuan Gueset</div>
                            <div class="incident-status">Status: <span class="text-active">Active</span></div>
                            <div class="incident-status">Assigned Team: JERICK & SHERWIN</div>
                            <button class="btn-show-map" onclick="routeToIncident(16.075000, 120.345000)">Show on Map & Route</button>
                        </div>
                    </div>
            </div>


            <div class="network-status-box" id="networkBox">
                    <div class="network-status-header">
                        <span>Network Status</span>
                    </div>
            </div>

        
    








            <div id="flames-map">

                <button id="home-btn" title="Home">
                    <img src="icons/home.png" alt="Home">
                </button>

                <button id="locate-btn" title="Show My Location">
                    <img src="icons/showmylocation.png" alt="Locate Me">
                </button>

                <div class="custom-zoom-group">
                    <button id="zoom-in" class="zoom-btn">+</button>
                    <div class="zoom-divider"></div> 
                    <button id="zoom-out" class="zoom-btn">−</button>
                </div>

                <button class="route-main-btn" id="route-btn" title="Route Planner">
                    <img id="routeplanner-icon" src="icons/RoutePlanner.png" />
                </button>

                <div class="route-menu" id="route-menu">
                    <button id="calc-route" class="calc-btn">Calculate</button>
                    <span class="divider">|</span>
                    <button id="clear-route" class="clear-btn">Clear</button>
                </div>

                <div id="route-info-box" style="display: none;">
                    <span id="route-dist"><img id="distance-icon" src="icons/distance.png"/> 0.00 km</span>
                    <span class="info-divider">|</span>
                    <span id="route-time"><img id="minutes-icon" src="icons/minutes.png"/>0 mins</span>
                    <button id="close-info-btn">×</button>
                </div>


            </div>



        <script>
            if (performance.navigation.type === performance.navigation.TYPE_RELOAD) {
                window.location.href = "index.html";
            }
        </script>


        <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
        <script src="https://unpkg.com/leaflet-routing-machine/dist/leaflet-routing-machine.js"></script>
        <script src ="static/map.js"></script>
        <script src="static/OpenRouteService.js"></script>
        <script src ="static/ProfileSettings.js"></script>


        <script>
    // ==================== REAL-TIME MQTT CONFIG ====================
    const MQTT_BROKER = "wss://528e719c19214a19b07c0e7322298267.s1.eu.hivemq.cloud:8884/mqtt";
    const MQTT_TOPIC  = "lora/uplink";
    const MQTT_USER   = "Downlink01";  // Change to your real user
    const MQTT_PASS   = "Downlink01";  // Change to your real pass

    const client = mqtt.connect(MQTT_BROKER, {
        username: MQTT_USER,
        password: MQTT_PASS,
        reconnectPeriod: 5000,
        clean: true
    });

    client.on('connect', () => {
        console.log("✅ Connected to HiveMQ – real-time active");
        client.subscribe(MQTT_TOPIC, (err) => {
            if (!err) {
                document.getElementById("mqtt-status").textContent = "Live feed connected";
            } else {
                document.getElementById("mqtt-status").textContent = "Connection error";
                console.error("Subscribe failed:", err);
            }
        });
    });

    client.on('message', (topic, message) => {
        try {
            const data = JSON.parse(message.toString());
            const payload = data.payload || {};
            const nodeId = payload.node;

            if (!nodeId) return;

            // Save latest data
            window.nodeDataCache[nodeId] = {
                temp: payload.temp,
                hum: payload.hum,
                flame: payload.flame || 0,
                smoke: payload.smoke || 0,
                lat: payload.lat,
                lon: payload.lon,
                rssi: data.rssi,
                snr: data.snr,
                received_at: data.received_at
            };

            // Create/update marker
            if (payload.lat && payload.lon) {
                createOrUpdateNodeMarker(nodeId, payload.lat, payload.lon);
            }

            // Update status if this node is selected
            const header = document.getElementById('header-right');
            if (header && header.textContent.includes(nodeId)) {
                updateNodeStatusCard(nodeId);
            }

            // Update incidents
            updateIncidents();

        } catch (err) {
            console.error("MQTT parse error:", err);
        }
    });

    client.on('error', (err) => {
        console.error("MQTT Error:", err);
        document.getElementById("mqtt-status").textContent = "Connection error – retrying...";
    });

    client.on('close', () => {
        console.log("MQTT disconnected – reconnecting...");
        document.getElementById("mqtt-status").textContent = "Disconnected – reconnecting...";
    });

    // ==================== UPDATE LIVE INCIDENTS ====================
    function updateIncidents() {
        const incidentList = document.getElementById("incident-list");
        const incidentCountEl = document.getElementById("incident-count");
        const noMsg = document.getElementById("no-incident-msg");

        if (!incidentList || !incidentCountEl) return;

        incidentList.innerHTML = "";
        let count = 0;

        Object.keys(window.nodeDataCache).forEach(nodeId => {
            const data = window.nodeDataCache[nodeId];
            if (data.flame === 1 || data.smoke > 500) {
                count++;
                const card = document.createElement("div");
                card.className = "incident-card";
                card.innerHTML = `
                    <div class="incident-title">${nodeId}</div>
                    <div class="incident-status">Status: <span class="text-active">Active</span></div>
                    <div class="incident-status">Detected: ${data.received_at ? new Date(data.received_at).toLocaleString('en-PH') : 'Just now'}</div>
                    <div class="incident-status">Assigned Team: JERICK & SHERWIN</div>
                    <button class="btn-show-map" onclick="routeToIncident(${data.lat || 16.0}, ${data.lon || 120.0})">Show on Map & Route</button>
                `;
                incidentList.appendChild(card);
            }
        });

        incidentCountEl.textContent = count;

        noMsg.style.display = count > 0 ? 'none' : 'block';
    }
</script>


    
</body>
</html>